<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>大明华容道 | MingDynasty</title>
  <script src="https://cdn.tailwindcss.com"></script>
        <link rel="icon" href="https://MingDynasty1.github.io/000000000000000000.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 配置Tailwind自定义颜色和字体 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ming: {
              red: '#C41E3A',      // 明朝红
              yellow: '#FFD700',   // 明黄
              blue: '#1E3A8A',     // 青花蓝
              green: '#0F766E',    // 翡翠绿
              gold: '#D4AF37',     // 金色
              brown: '#8B4513',    // 木色
              beige: '#F5F5DC',    // 米色
              dark: '#1C1917',     // 深色
              darkbg: '#2D2A26'    // 暗色背景
            }
          },
          fontFamily: {
            song: ['SimSun', 'serif']  // 宋体，符合明朝印刷风格
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .bg-pattern-light {
        background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4af37' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
      }
      .bg-pattern-dark {
        background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d4af37' fill-opacity='0.05' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
      }
      .border-pattern {
        background-image: linear-gradient(45deg, #D4AF37 25%, transparent 25%), 
                          linear-gradient(-45deg, #D4AF37 25%, transparent 25%), 
                          linear-gradient(45deg, transparent 75%, #D4AF37 75%), 
                          linear-gradient(-45deg, transparent 75%, #D4AF37 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      }
      .piece-shadow {
        box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.3), 
                   inset 2px 2px 3px rgba(255, 255, 255, 0.2);
      }
      .piece-shadow-dark {
        box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.5), 
                   inset 2px 2px 3px rgba(255, 255, 255, 0.1);
      }
      .wood-texture {
        background-image: linear-gradient(90deg, rgba(139, 69, 19, 0.1) 50%, transparent 50%),
                          linear-gradient(rgba(139, 69, 19, 0.2) 50%, transparent 50%);
        background-size: 20px 20px;
      }
      .wood-texture-dark {
        background-image: linear-gradient(90deg, rgba(101, 51, 0, 0.2) 50%, transparent 50%),
                          linear-gradient(rgba(101, 51, 0, 0.3) 50%, transparent 50%);
        background-size: 20px 20px;
      }
    }
  </style>
</head>
<body class="theme-light bg-ming-beige bg-pattern-light min-h-screen font-song text-ming-dark flex flex-col items-center justify-center p-4 transition-colors duration-300">
  
  <!-- 主题切换按钮 -->
  <button id="themeToggle" class="absolute top-4 right-4 bg-ming-red text-ming-yellow p-2 rounded-full border-2 border-ming-gold transition-all duration-300 hover:bg-ming-dark">
    <i class="fa fa-moon-o"></i>
  </button>
  
  <!-- 游戏标题 -->
  <header class="text-center mb-6">
    <div class="inline-block border-4 border-ming-gold bg-ming-red px-8 py-3 rounded-lg relative overflow-hidden">
      <div class="absolute inset-0 opacity-20 wood-texture"></div>
      <h1 class="text-4xl md:text-5xl font-bold text-ming-yellow relative z-10 tracking-wider">大明华容道</h1>
      <p class="text-ming-beige mt-1 text-sm md:text-base">移动棋子，帮助洪武帝脱身</p>
    </div>
  </header>
  
  <!-- 游戏主容器 -->
  <div class="flex flex-col md:flex-row gap-8 items-center md:items-start">
    
    <!-- 游戏信息面板 -->
    <div class="w-full md:w-64 bg-ming-brown bg-opacity-90 rounded-lg p-4 border-2 border-ming-gold piece-shadow transition-all duration-300">
      <div class="text-ming-beige text-center mb-4 pb-2 border-b border-ming-gold border-opacity-50">
        <h2 class="text-xl font-bold">游戏信息</h2>
      </div>
      
      <div class="mb-4">
        <p class="text-ming-beige mb-2"><i class="fa fa-signal text-ming-yellow mr-2"></i> 步数: <span id="moveCount" class="font-bold">0</span></p>
        <p class="text-ming-beige mb-2"><i class="fa fa-clock-o text-ming-yellow mr-2"></i> 时间: <span id="timer" class="font-bold">00:00</span></p>
      </div>
      
      <div class="space-y-2 mb-4">
        <button id="restartBtn" class="w-full bg-ming-red hover:bg-red-700 text-ming-beige py-2 px-4 rounded border border-ming-gold transition-all duration-300 flex items-center justify-center">
          <i class="fa fa-refresh mr-2"></i> 重新开始
        </button>
        <button id="hintBtn" class="w-full bg-ming-blue hover:bg-blue-800 text-ming-beige py-2 px-4 rounded border border-ming-gold transition-all duration-300 flex items-center justify-center">
          <i class="fa fa-lightbulb-o mr-2"></i> 提示
        </button>
      </div>
      
      <div class="text-ming-beige text-sm">
        <h3 class="text-ming-yellow font-bold mb-1">游戏说明</h3>
        <p class="mb-1">移动棋子，让洪武帝(朱元璋)从底部中间的出口逃出。</p>
        <p>点击棋子，然后向空白处移动。</p>
      </div>
    </div>
    
    <!-- 游戏棋盘 -->
    <div id="gameContainer" class="relative">
      <!-- 棋盘边框装饰 -->
      <div class="absolute -inset-4 border-pattern rounded-lg"></div>
      
      <!-- 棋盘主体 -->
      <div id="board" class="relative bg-ming-brown border-8 border-ming-gold rounded-lg wood-texture p-1 transition-all duration-300">
        <!-- 棋子将通过JS动态生成 -->
      </div>
      
      <!-- 出口标记 -->
      <div class="absolute left-1/2 -bottom-8 transform -translate-x-1/2 bg-ming-red text-ming-yellow px-4 py-1 rounded-full border-2 border-ming-gold text-sm font-bold transition-all duration-300">
        出口
      </div>
    </div>
    
    <!-- 角色说明 -->
    <div class="w-full md:w-64 bg-ming-brown bg-opacity-90 rounded-lg p-4 border-2 border-ming-gold piece-shadow transition-all duration-300">
      <div class="text-ming-beige text-center mb-4 pb-2 border-b border-ming-gold border-opacity-50">
        <h2 class="text-xl font-bold">人物介绍</h2>
      </div>
      
      <div class="space-y-3 text-ming-beige text-sm">
        <div class="flex items-center">
          <div class="w-8 h-8 bg-ming-yellow text-ming-red rounded-sm flex items-center justify-center font-bold mr-2">朱</div>
          <div>
            <p class="font-bold text-ming-yellow">洪武帝 (朱元璋)</p>
            <p>明朝开国皇帝，需要脱身</p>
          </div>
        </div>
        
        <div class="flex items-center">
          <div class="w-8 h-4 bg-ming-blue text-ming-beige rounded-sm flex items-center justify-center font-bold mr-2">徐</div>
          <div>
            <p class="font-bold text-ming-yellow">徐达</p>
            <p>明朝开国名将</p>
          </div>
        </div>
        
        <div class="flex items-center">
          <div class="w-4 h-8 bg-ming-green text-ming-beige rounded-sm flex items-center justify-center font-bold mr-2">常</div>
          <div>
            <p class="font-bold text-ming-yellow">常遇春</p>
            <p>明朝开国名将</p>
          </div>
        </div>
        
        <div class="flex items-center">
          <div class="w-4 h-4 bg-ming-red text-ming-beige rounded-sm flex items-center justify-center font-bold mr-2">刘</div>
          <div>
            <p class="font-bold text-ming-yellow">刘伯温</p>
            <p>明朝开国谋士</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 胜利弹窗 -->
  <div id="winModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="bg-ming-red border-8 border-ming-gold rounded-lg p-8 max-w-md w-full text-center relative transition-all duration-300">
      <div class="absolute -top-6 -right-6 w-16 h-16 bg-ming-yellow rounded-full border-4 border-ming-gold flex items-center justify-center transform rotate-12">
        <i class="fa fa-trophy text-3xl text-ming-red"></i>
      </div>
      <h2 class="text-3xl font-bold text-ming-yellow mb-4">恭喜获胜！</h2>
      <p class="text-ming-beige mb-2">您已成功帮助洪武帝脱身</p>
      <p class="text-ming-beige mb-6">步数: <span id="finalMoves" class="font-bold text-ming-yellow">0</span> | 时间: <span id="finalTime" class="font-bold text-ming-yellow">00:00</span></p>
      <button id="playAgainBtn" class="bg-ming-brown hover:bg-brown-800 text-ming-beige py-2 px-6 rounded border border-ming-gold transition-all duration-300 text-lg font-bold">
        再玩一次
      </button>
    </div>
  </div>

  <script>
    // 游戏配置
    const config = {
      gridSize: 4,          // 4x4 网格
      cellSize: 80,         // 每个格子的大小(像素)
      pieceTypes: {
        // 朱元璋 (2x2)
        zhu: { 
          name: "朱元璋", 
          shortName: "朱", 
          color: "bg-ming-yellow text-ming-red",
          colorDark: "bg-ming-yellow text-ming-dark",
          width: 2, 
          height: 2,
          isTarget: true
        },
        // 徐达 (1x2)
        xu: { 
          name: "徐达", 
          shortName: "徐", 
          color: "bg-ming-blue text-ming-beige",
          colorDark: "bg-ming-blue/80 text-ming-beige",
          width: 2, 
          height: 1 
        },
        // 常遇春 (2x1)
        chang: { 
          name: "常遇春", 
          shortName: "常", 
          color: "bg-ming-green text-ming-beige",
          colorDark: "bg-ming-green/80 text-ming-beige",
          width: 1, 
          height: 2 
        },
        // 刘伯温 (1x1)
        liu: { 
          name: "刘伯温", 
          shortName: "刘", 
          color: "bg-ming-red text-ming-beige",
          colorDark: "bg-ming-red/80 text-ming-beige",
          width: 1, 
          height: 1 
        },
        // 空白位置
        empty: { 
          name: "空白", 
          color: "bg-ming-brown bg-opacity-50",
          colorDark: "bg-ming-darkbg bg-opacity-70",
          width: 1, 
          height: 1,
          isEmpty: true
        }
      }
    };

    // 初始布局 - 4x4 网格
    const initialLayout = [
      [{type: 'xu', id: 'xu1'}, {type: 'xu', id: 'xu1'}, {type: 'chang', id: 'chang1'}, {type: 'chang', id: 'chang2'}],
      [{type: 'zhu', id: 'zhu1'}, {type: 'zhu', id: 'zhu1'}, {type: 'chang', id: 'chang1'}, {type: 'chang', id: 'chang2'}],
      [{type: 'zhu', id: 'zhu1'}, {type: 'zhu', id: 'zhu1'}, {type: 'liu', id: 'liu1'}, {type: 'liu', id: 'liu2'}],
      [{type: 'chang', id: 'chang3'}, {type: 'chang', id: 'chang4'}, {type: 'liu', id: 'liu3'}, {type: 'empty', id: 'empty1'}]
    ];

    // 游戏状态
    const gameState = {
      layout: JSON.parse(JSON.stringify(initialLayout)),
      selectedPiece: null,
      moveCount: 0,
      startTime: null,
      timerInterval: null,
      elapsedTime: 0,
      isDarkMode: false
    };

    // DOM 元素
    const boardElement = document.getElementById('board');
    const moveCountElement = document.getElementById('moveCount');
    const timerElement = document.getElementById('timer');
    const restartBtn = document.getElementById('restartBtn');
    const hintBtn = document.getElementById('hintBtn');
    const winModal = document.getElementById('winModal');
    const finalMovesElement = document.getElementById('finalMoves');
    const finalTimeElement = document.getElementById('finalTime');
    const playAgainBtn = document.getElementById('playAgainBtn');
    const themeToggle = document.getElementById('themeToggle');
    const bodyElement = document.body;

    // 切换明暗主题
    function toggleTheme() {
      gameState.isDarkMode = !gameState.isDarkMode;
      
      // 更新主题类
      if (gameState.isDarkMode) {
        bodyElement.classList.remove('theme-light', 'bg-ming-beige', 'bg-pattern-light', 'text-ming-dark');
        bodyElement.classList.add('theme-dark', 'bg-ming-darkbg', 'bg-pattern-dark', 'text-ming-beige');
        
        // 更新棋盘纹理
        boardElement.classList.remove('wood-texture');
        boardElement.classList.add('wood-texture-dark');
        
        // 更新面板和棋子阴影
        document.querySelectorAll('.piece-shadow').forEach(el => {
          el.classList.remove('piece-shadow');
          el.classList.add('piece-shadow-dark');
        });
        
        // 更新主题按钮图标
        themeToggle.innerHTML = '<i class="fa fa-sun-o"></i>';
      } else {
        bodyElement.classList.remove('theme-dark', 'bg-ming-darkbg', 'bg-pattern-dark', 'text-ming-beige');
        bodyElement.classList.add('theme-light', 'bg-ming-beige', 'bg-pattern-light', 'text-ming-dark');
        
        // 更新棋盘纹理
        boardElement.classList.remove('wood-texture-dark');
        boardElement.classList.add('wood-texture');
        
        // 更新面板和棋子阴影
        document.querySelectorAll('.piece-shadow-dark').forEach(el => {
          el.classList.remove('piece-shadow-dark');
          el.classList.add('piece-shadow');
        });
        
        // 更新主题按钮图标
        themeToggle.innerHTML = '<i class="fa fa-moon-o"></i>';
      }
      
      // 重新渲染棋盘以应用主题变化
      renderBoard();
    }

    // 初始化棋盘大小
    function initBoardSize() {
      const boardSize = config.gridSize * config.cellSize;
      boardElement.style.width = `${boardSize}px`;
      boardElement.style.height = `${boardSize}px`;
    }

    // 渲染棋盘
    function renderBoard() {
      boardElement.innerHTML = '';
      
      for (let row = 0; row < config.gridSize; row++) {
        for (let col = 0; col < config.gridSize; col++) {
          const cellData = gameState.layout[row][col];
          const pieceType = config.pieceTypes[cellData.type];
          
          // 只创建每个棋子的左上角单元格
          if (isTopLeftCell(row, col, cellData.id)) {
            const pieceElement = document.createElement('div');
            const pieceId = cellData.id;
            const width = pieceType.width * config.cellSize;
            const height = pieceType.height * config.cellSize;
            
            // 根据主题选择颜色
            const colorClass = gameState.isDarkMode ? pieceType.colorDark : pieceType.color;
            
            // 设置棋子样式
            pieceElement.className = `absolute rounded-sm flex items-center justify-center transition-all duration-200 ${colorClass} ${gameState.isDarkMode ? 'piece-shadow-dark' : 'piece-shadow'}`;
            pieceElement.style.width = `${width}px`;
            pieceElement.style.height = `${height}px`;
            pieceElement.style.left = `${col * config.cellSize}px`;
            pieceElement.style.top = `${row * config.cellSize}px`;
            pieceElement.dataset.id = pieceId;
            pieceElement.dataset.type = cellData.type;
            
            // 添加棋子文本
            if (!pieceType.isEmpty) {
              pieceElement.innerHTML = `
                <div class="text-center">
                  <div class="font-bold text-lg">${pieceType.shortName}</div>
                  <div class="text-xs opacity-70">${pieceType.name}</div>
                </div>
              `;
              
              // 添加点击事件
              pieceElement.addEventListener('click', () => handlePieceClick(pieceId, row, col));
            }
            
            boardElement.appendChild(pieceElement);
          }
        }
      }
    }

    // 检查是否是棋子的左上角单元格
    function isTopLeftCell(row, col, pieceId) {
      // 对于空白格，每个都是独立的
      if (gameState.layout[row][col].type === 'empty') {
        return true;
      }
      
      // 检查上方是否有相同ID的单元格
      if (row > 0 && gameState.layout[row - 1][col].id === pieceId) {
        return false;
      }
      
      // 检查左方是否有相同ID的单元格
      if (col > 0 && gameState.layout[row][col - 1].id === pieceId) {
        return false;
      }
      
      return true;
    }

    // 处理棋子点击
    function handlePieceClick(pieceId, row, col) {
      const pieceData = gameState.layout[row][col];
      const pieceType = config.pieceTypes[pieceData.type];
      
      // 如果点击的是空白格，尝试移动选中的棋子
      if (pieceType.isEmpty && gameState.selectedPiece) {
        moveSelectedPieceTo(row, col);
        return;
      }
      
      // 如果点击的是已有棋子，选中它
      if (!pieceType.isEmpty) {
        // 清除之前的选中状态
        clearSelection();
        
        // 设置新的选中状态
        gameState.selectedPiece = {
          id: pieceId,
          type: pieceData.type,
          row,
          col,
          width: pieceType.width,
          height: pieceType.height
        };
        
        // 高亮选中的棋子
        highlightSelectedPiece(pieceId);
        
        // 高亮可移动的方向
        highlightPossibleMoves();
      }
    }

    // 清除选中状态
    function clearSelection() {
      if (gameState.selectedPiece) {
        // 移除高亮
        const selectedElement = document.querySelector(`[data-id="${gameState.selectedPiece.id}"]`);
        if (selectedElement) {
          selectedElement.classList.remove('ring-4', 'ring-ming-gold');
        }
        
        // 清除可能的移动高亮
        document.querySelectorAll('.possible-move').forEach(el => {
          el.remove();
        });
        
        gameState.selectedPiece = null;
      }
    }

    // 高亮选中的棋子
    function highlightSelectedPiece(pieceId) {
      const pieceElement = document.querySelector(`[data-id="${pieceId}"]`);
      if (pieceElement) {
        pieceElement.classList.add('ring-4', 'ring-ming-gold');
      }
    }

    // 高亮可能的移动方向
    function highlightPossibleMoves() {
      if (!gameState.selectedPiece) return;
      
      const { row, col, width, height } = gameState.selectedPiece;
      
      // 检查向上移动
      if (row > 0 && isEmptyArea(row - 1, col, width, 1)) {
        createMoveIndicator(row - 1, col);
      }
      
      // 检查向下移动
      if (row + height < config.gridSize && isEmptyArea(row + height, col, width, 1)) {
        createMoveIndicator(row + height, col);
      }
      
      // 检查向左移动
      if (col > 0 && isEmptyArea(row, col - 1, 1, height)) {
        createMoveIndicator(row, col - 1);
      }
      
      // 检查向右移动
      if (col + width < config.gridSize && isEmptyArea(row, col + width, 1, height)) {
        createMoveIndicator(row, col + width);
      }
    }

    // 创建移动指示器
    function createMoveIndicator(row, col) {
      const indicator = document.createElement('div');
      const bgColor = gameState.isDarkMode ? 'bg-ming-gold/50' : 'bg-ming-gold/30';
      indicator.className = `possible-move absolute ${bgColor} rounded-sm cursor-pointer`;
      indicator.style.width = `${config.cellSize}px`;
      indicator.style.height = `${config.cellSize}px`;
      indicator.style.left = `${col * config.cellSize}px`;
      indicator.style.top = `${row * config.cellSize}px`;
      indicator.addEventListener('click', () => moveSelectedPieceTo(row, col));
      boardElement.appendChild(indicator);
    }

    // 检查区域是否为空
    function isEmptyArea(startRow, startCol, width, height) {
      for (let r = 0; r < height; r++) {
        for (let c = 0; c < width; c++) {
          const row = startRow + r;
          const col = startCol + c;
          
          if (row >= config.gridSize || col >= config.gridSize) {
            return false;
          }
          
          if (gameState.layout[row][col].type !== 'empty') {
            return false;
          }
        }
      }
      return true;
    }

    // 移动选中的棋子到目标位置
    function moveSelectedPieceTo(targetRow, targetCol) {
      if (!gameState.selectedPiece) return;
      
      const { id, type, row: originalRow, col: originalCol, width, height } = gameState.selectedPiece;
      
      // 确定移动方向和距离
      let direction;
      let steps = 0;
      
      // 向上移动
      if (targetRow < originalRow && targetCol === originalCol) {
        direction = 'up';
        steps = originalRow - targetRow;
      }
      // 向下移动
      else if (targetRow > originalRow && targetCol === originalCol && targetRow === originalRow + height) {
        direction = 'down';
        steps = 1;
      }
      // 向左移动
      else if (targetCol < originalCol && targetRow === originalRow) {
        direction = 'left';
        steps = originalCol - targetCol;
      }
      // 向右移动
      else if (targetCol > originalCol && targetRow === originalRow && targetCol === originalCol + width) {
        direction = 'right';
        steps = 1;
      }
      // 无效移动
      else {
        return;
      }
      
      // 执行移动
      const newRow = direction === 'up' ? originalRow - steps : 
                    direction === 'down' ? originalRow + steps : originalRow;
      const newCol = direction === 'left' ? originalCol - steps : 
                    direction === 'right' ? originalCol + steps : originalCol;
      
      // 更新布局
      updateLayoutAfterMove(id, originalRow, originalCol, newRow, newCol, width, height);
      
      // 清除选中状态
      clearSelection();
      
      // 增加移动计数
      gameState.moveCount++;
      moveCountElement.textContent = gameState.moveCount;
      
      // 重新渲染棋盘
      renderBoard();
      
      // 检查是否获胜
      checkWinCondition();
    }

    // 移动后更新布局
    function updateLayoutAfterMove(pieceId, originalRow, originalCol, newRow, newCol, width, height) {
      const pieceType = gameState.layout[originalRow][originalCol].type;
      
      // 清空原位置
      for (let r = 0; r < height; r++) {
        for (let c = 0; c < width; c++) {
          gameState.layout[originalRow + r][originalCol + c] = {
            type: 'empty',
            id: `empty-${Date.now()}-${r}-${c}`
          };
        }
      }
      
      // 填充新位置
      for (let r = 0; r < height; r++) {
        for (let c = 0; c < width; c++) {
          gameState.layout[newRow + r][newCol + c] = {
            type: pieceType,
            id: pieceId
          };
        }
      }
    }

    // 检查获胜条件 (朱元璋到达底部中间位置)
    function checkWinCondition() {
      // 查找朱元璋的位置
      let zhuRow = -1;
      let zhuCol = -1;
      
      outerLoop:
      for (let row = 0; row < config.gridSize; row++) {
        for (let col = 0; col < config.gridSize; col++) {
          if (gameState.layout[row][col].type === 'zhu') {
            zhuRow = row;
            zhuCol = col;
            break outerLoop;
          }
        }
      }
      
      // 朱元璋是2x2的棋子，获胜条件是他的底部到达最后一行中间
      if (zhuRow === config.gridSize - 2 && zhuCol === 1) {
        endGame(true);
      }
    }

    // 提示功能
    function showHint() {
      // 简单的提示算法：寻找可以移动的棋子
      for (let row = 0; row < config.gridSize; row++) {
        for (let col = 0; col < config.gridSize; col++) {
          const cellData = gameState.layout[row][col];
          if (cellData.type === 'empty' || !isTopLeftCell(row, col, cellData.id)) {
            continue;
          }
          
          const pieceType = config.pieceTypes[cellData.type];
          const width = pieceType.width;
          const height = pieceType.height;
          
          // 检查是否可以移动
          if (
            (row > 0 && isEmptyArea(row - 1, col, width, 1)) ||
            (row + height < config.gridSize && isEmptyArea(row + height, col, width, 1)) ||
            (col > 0 && isEmptyArea(row, col - 1, 1, height)) ||
            (col + width < config.gridSize && isEmptyArea(row, col + width, 1, height))
          ) {
            // 清除之前的选中状态
            clearSelection();
            
            // 选中可移动的棋子
            gameState.selectedPiece = {
              id: cellData.id,
              type: cellData.type,
              row,
              col,
              width,
              height
            };
            
            // 高亮选中的棋子
            highlightSelectedPiece(cellData.id);
            
            // 高亮可移动的方向
            highlightPossibleMoves();
            
            return;
          }
        }
      }
    }

    // 格式化时间显示
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // 开始计时器
    function startTimer() {
      if (!gameState.startTime) {
        gameState.startTime = new Date();
        gameState.timerInterval = setInterval(() => {
          gameState.elapsedTime = Math.floor((new Date() - gameState.startTime) / 1000);
          timerElement.textContent = formatTime(gameState.elapsedTime);
        }, 1000);
      }
    }

    // 停止计时器
    function stopTimer() {
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
      }
    }

    // 重置游戏
    function resetGame() {
      // 重置游戏状态
      gameState.layout = JSON.parse(JSON.stringify(initialLayout));
      gameState.selectedPiece = null;
      gameState.moveCount = 0;
      gameState.startTime = null;
      gameState.elapsedTime = 0;
      
      // 更新UI
      moveCountElement.textContent = '0';
      timerElement.textContent = '00:00';
      
      // 停止计时器
      stopTimer();
      
      // 隐藏胜利弹窗
      winModal.classList.add('hidden');
      
      // 重新渲染棋盘
      renderBoard();
      
      // 开始计时
      startTimer();
    }

    // 结束游戏
    function endGame(isWin) {
      // 停止计时器
      stopTimer();
      
      if (isWin) {
        // 显示胜利弹窗
        finalMovesElement.textContent = gameState.moveCount;
        finalTimeElement.textContent = formatTime(gameState.elapsedTime);
        winModal.classList.remove('hidden');
      }
    }

    // 初始化游戏
    function initGame() {
      initBoardSize();
      renderBoard();
      
      // 事件监听
      restartBtn.addEventListener('click', resetGame);
      hintBtn.addEventListener('click', showHint);
      playAgainBtn.addEventListener('click', resetGame);
      themeToggle.addEventListener('click', toggleTheme);
      
      // 开始计时
      startTimer();
    }

    // 页面加载完成后初始化游戏
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
